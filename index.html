<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>Karaoké</title>
    <style>
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0; padding: 0;

        height: 100%;
      }
      body {
        height: 100%;
        margin: 0; padding: 0;
      }
      #videos {
        display: flex;
        flex-direction: row;
      }
      #videos video,
      #videos canvas {
        transform: rotateY(180deg);
        max-height: 200px;
        object-fit: contain;
      }
    </style>
  </head>

  <body>
    <button id="stop">STOP</button>
    <div id="videos"></div>
    <script type="module">
      import * as media  from "./media.js";
      import Webcam      from "./webcam.js";
      import VideoChroma from "./video-chroma.js";

      function str (s)
      {
        return s.normalize ('NFD').replace (/\p{Diacritic}/gu, '').toLowerCase ();
      }
      console.log (str ('Beyoncé'));

      let karaoke = window.open ('karaoke.html', 'Karaoke');
      if (karaoke != null)
      {
        let constraints = {audio: false, video: {width: {min: 1280, ideal: 1920}, height: {min: 720, ideal: 1080}}};
        let webcam = new Webcam (constraints);
        webcam.video.id = "webcam";
        let videos = document.getElementById ('videos');
        videos.appendChild (webcam.video);

        webcam.ready.then (() => {
          webcam.video.play ();
          let chroma = new VideoChroma (webcam.video);
          videos.appendChild (chroma.canvas);

          webcam.video.onclick = e => {
            console.log (e);
            console.log (e.offsetX, e.offsetY);
            console.log (getComputedStyle (e.target));

            let canvas = document.createElement ('canvas');
            let w = canvas.width  = webcam.video.clientWidth;
            let h = canvas.height = webcam.video.clientHeight;
            //document.body.appendChild (canvas);
            //console.log (w, h);

            let context = canvas.getContext ('2d');
            context.drawImage (webcam.video, 0, 0, w, h);
            let [r, g, b] = context.getImageData (e.offsetX, e.offsetY, 1, 1).data;
            console.log (r, g, b);

            chroma.chroma_key = [r, g, b];
            karaoke.postMessage ({type: 'chroma-key', value: [r, g, b]});
          };
        });

        let test = document.createElement ('video');
        test.muted = true;
        test.onclick = media.ONCLICK (test, (r, g, b) => console.log (r, g, b));
        media.LOAD (test, 'songs/garou-sous_le_vent.mp4').
          then (() => {
            test.play ();
            document.body.appendChild (test);
          });
        

        fetch ('songs.json').
          then (r => r.json ()).
          then (json => {
            json.forEach (song => {
              console.log (song.title);
              let button = document.createElement ('button');
              //button.innerHTML = song.artist + ' - ' + song.title;
              let img = document.createElement ('img');
              img.width = 150;
              img.height = 150;
              img.src = song.icon;
              button.appendChild (img);
              button.onclick = () => karaoke.postMessage ({type: 'play', song});
              document.body.appendChild (button);
            });
          });

        let stop = document.getElementById ('stop');
        stop.onclick = () => karaoke.postMessage ({type: 'stop'});
      }
    </script>
  </body>
</html>
