<!doctype html>
<html lang="fr" class="w-100 h-100">
  <head>
    <meta charset="utf-8">
    <title>Karaoké</title>
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- Bootstrap Icons -->
    <link href="bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  </head>
  <body class="w-100 h-100">
    <!-- Chroma Key -->
    <div class="modal" id="chroma-picker">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chroma Key</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <div id="chroma-webcam"></div>
            <div id="chroma-preview"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Propriétés d'une chanson -->
    <div class="modal" id="song-properties">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Propriétés</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label>Artiste</label>
                <input id="song-artist" class="form-control"></input>
              </div>
              <div class="form-group mt-2">
                <label>Titre</label>
                <input id="song-title" class="form-control"></input>
              </div>
              <div id="song-cdg" style="display:none;">
                <div class="form-group mt-2">
                  <label>Audio</label>
                  <input id="song-cdg-audio" class="form-control" readonly></input>
                  <!--audio controls muted id="song-cdg-audio" class="w-100"></audio-->
                </div>
                <div class="form-group mt-2">
                  <label>Paroles</label>
                  <input id="song-cdg-lyrics" class="form-control" readonly></input>
                  <!--canvas id="song-cdg-lyrics" class="w-100"></canvas-->
                </div>
              </div>
              <div class="form-group mt-2" id="song-karafun" style="display:none;">
                <label>Vidéo</label>
                <video muted loop id="song-karafun-video" class="w-100"></video>
                <div class="d-flex justify-content-between">
                  <span id="song-karafun-colors"></span>
                  <button id="song-karafun-pause" type="button" class="btn border" style="width:50px;height:50px;">
                    <i class="bi-pause-fill"></i>
                  </button>
                </div>
              </div>
              <div class="form-group mt-2" id="song-singking" style="display:none;">
                <label>Vidéo</label>
                <video muted id="song-singking-video" class="w-100"></video>
              </div>
              <button type="submit" class="d-none">Bouton caché mais nécessaire</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Nouvelle chanson -->
    <div class="modal" id="new-song">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Téléchargement</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label>Artiste</label>
                <input id="new-artist" class="form-control" required></input>
              </div>
              <div class="form-group mt-2">
                <label>Titre</label>
                <input id="new-title" class="form-control" required></input>
              </div>
              <div class="form-group mt-2">
                <label>URL</label>
                <input id="new-video" class="form-control" required></input>
              </div>
              <div class="form-group mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="new-video-type" value="karafun" id="new-video-karafun" required>
                  <label class="form-check-label" for="new-video-karafun">Karafun</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="new-video-type" value="singking" id="new-video-singking" required>
                  <label class="form-check-label" for="new-video-singking">Sing King</label>
                </div>
              </div>
              <button type="submit" class="d-none">Bouton caché mais nécessaire</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary">Télécharger</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Barre d'outils -->
    <nav class="navbar navbar-expand-md navbar-light fixed-top bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Karaoké</a>
        <form class="d-flex">
          <input class="form-control me-2" type="search" placeholder="Rechercher" aria-label="Rechercher">
          <button class="btn btn-outline-success" type="submit"><i class="bi-search"></i></button>
        </form>
      </div>
    </nav>
    <!-- Barre d'outils -->
    <div class="btn-group-vertical float-start m-2 fixed-top" role="toolbar" style="top:56px;right:auto;">
      <div class="btn-group-vertical mb-2" role="group">
        <button type="button" class="btn btn-light" id="chroma" data-bs-toggle="modal" data-bs-target="#chroma-picker"><i class="bi-eyedropper"></i></button>
      </div>
      <div class="btn-group-vertical mb-2" role="group">
        <button type="button" class="btn btn-light" id="new-song-download" data-bs-toggle="modal" data-bs-target="#new-song"><i class="bi-cloud-plus"></i></button>
        <button type="button" class="btn btn-light" id="new-song-import" data-bs-toggle="modal" data-bs-target="#new-song"><i class="bi-file-earmark-plus"></i></button>
        <button type="button" class="btn btn-light" id="download"><i class="bi-download"></i></button>
      </div>
      <div class="btn-group-vertical mb-2" role="group">
        <button type="button" class="btn btn-light" id="stop"><i class="bi-stop-fill"></i></button>
      </div>
      <div class="btn-group-vertical" role="group">
        <button type="button" class="btn btn-light" disabled><i class="bi-symmetry-vertical"></i></button>
        <button type="button" class="btn btn-light" disabled><i class="bi-arrow-clockwise"></i></button>
      </div>
    </div>
    <!-- Liste des chansons -->
    <ul id="songs" class="list-group list-group-flush w-75 mx-auto" style="margin-top:56px;"></ul>
    <script type="module">
      import * as media  from "./js/media.js";
      import Webcam      from "./js/webcam.js";
      import VideoChroma from "./js/video-chroma.js";
      import Properties  from "./js/song-properties.js";
      import Wizard      from "./js/song-wizard.js";

      let songs = [];
      let selection = [];
      let confirm_reload = true; // FIXME?

      function download ()
      {
        let a = document.createElement ('a');
        let file = new Blob ([JSON.stringify (songs, null, 2)], {type: 'text/json'});
        a.href = URL.createObjectURL (file);
        a.download = 'songs.json';
        a.click ();
      }

      function str (s)
      {
        return s.normalize ('NFD').replace (/\p{Diacritic}/gu, '').toLowerCase ();
      }
      console.log (str ('Beyoncé'));

      // Fenêtre secondaire.
      let karaoke = window.open ('karaoke.html', 'Karaoke');
      if (karaoke != null)
      {
        // Webcam
        let constraints = {audio: false, video: {width: {min: 1280, ideal: 1920}, height: {min: 720, ideal: 1080}}};
        let webcam = new Webcam (constraints);
        // Dès que la webcam est prête...
        webcam.ready.then (() => {
          // Fenêtre de dialogue.
          let modal = document.getElementById ('chroma-picker');
          let body = modal.querySelector ('.modal-body');
          // Dès que la fenêtre s'affiche...
          modal.addEventListener ('show.bs.modal', e => {
            // Démarrage de la vidéo.
            webcam.video.play ();
            // Création du filtre "chroma-key".
            let chroma = new VideoChroma (webcam.video);
            // Gestion du clic sur la vidéo.
            webcam.video.onclick = media.ONCLICK (webcam.video, rgb => {
              console.log ('onclick', rgb);
              chroma.chroma_key = rgb;
              karaoke.postMessage ({type: 'chroma-key', value: rgb});
            });
            // Ajout des éléments.
            body.appendChild (webcam.video);
            webcam.video.style.width = "50%";
            body.appendChild (chroma.canvas);
            chroma.canvas.style.width = "50%";
            // Suppression des éléments à la fermeture.
            let listener = () => {
              //console.log ('hidden.bs.modal');
              body.removeChild (webcam.video);
              body.removeChild (chroma.canvas);
              chroma.dispose ();
            };
            modal.addEventListener ('hidden.bs.modal', listener, {once: true});
          });
        });

        // Propriétés d'une chanson.
        let properties = new Properties ('song-properties', () => {
          confirm_reload = true;
          song_list ();
        });

        // Téléchargement d'une nouvelle vidéo.
        let wizard = new Wizard ('new-song', song => {
          confirm_reload = true;
          songs.unshift (song);
          song_list ();
        });

        function song_item_icon (song)
        {
          if (! song.icon)
            return 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='

          if (/^https?:\/\//.test (song.icon))
            return song.icon;

          return 'songs/' + song.icon;
        }

        function song_item (song)
        {
          let img = document.createElement ('img');
          img.className = 'm-1';
          img.width = 50;
          img.height = 50;
          img.src = song_item_icon (song);
          img.onclick = () => karaoke.postMessage ({type: 'play', song});

          let title = document.createElement ('div');
          title.innerHTML = song.title;
          let artist = document.createElement ('div');
          artist.className = 'text-secondary';
          artist.innerHTML = song.artist;
          let text = document.createElement ('div');
          text.className = 'd-flex flex-column flex-grow-1 m-2';
          text.append (title, artist);

          let settings = document.createElement ('button');
          settings.className = 'btn m-1';
          settings.innerHTML = '<i class="bi-three-dots"></i>';
          settings.onclick = () => properties.show (song);

          let li = document.createElement ('li');
          li.className = 'list-group-item d-flex flex-row align-items-center';
          li.append (img, text, settings);
          return li;
        }

        function song_list ()
        {
          console.log ('song_list');
          let list = document.getElementById ('songs');
          list.innerHTML = '';
          selection.forEach (song => {
            console.log (song.title);
            list.append (song_item (song));
          });
        }

        fetch ('songs.json').
          then (r => r.json ()).
          then (json => {
            songs = json;
            selection = songs;
            song_list ();
          });

        {
          let button = document.getElementById ('download');
          button.onclick = download;
        }

        {
          let button = document.getElementById ('stop');
          button.onclick = () => karaoke.postMessage ({type: 'stop'});
        }
      }

      window.onbeforeunload = e => {
        if (confirm_reload)
        {
          e.returnValue = "Interrompre le karaoké ?";
          e.preventDefault ();
        }
      }
    </script>
    <div class="text-center">
      <a href="https://www.youtube.com/user/karafunfr/videos" target="_blank">KaraFun France</a>
      <span>&bullet;</span>
      <a href="https://www.youtube.com/user/karafun/videos" target="_blank">KaraFun</a>
      <span>&bullet;</span>
      <a href="https://www.youtube.com/c/singkingkaraoke/videos" target="_blank">Sing King</a>
      <span>&bullet;</span>
      <a href="https://www.youtube.com/channel/UCObchMolWdiUqpdjUGRPUcA/videos" target="_blank">Sing Now!</a>
      <span>&bullet;</span>
      <a href="https://www.youtube.com/user/KaraokeOnVEVO/videos" target="_blank">Karaoke on Vevo</a>
    </div>
  </body>
</html>
