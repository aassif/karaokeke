<!doctype html>
<html lang="fr" class="w-100 h-100">
  <head>
    <meta charset="utf-8">
    <title>Karaoké</title>
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- Bootstrap Icons -->
    <link href="bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  </head>
  <body class="w-100 h-100">
    <!-- Chroma Key -->
    <div class="modal" id="modal:chroma">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chroma Key</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <!--video muted></video-->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Propriétés d'une chanson -->
    <div class="modal" id="modal:song">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Propriétés</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label>Titre</label>
                <input id="song-artist" class="form-control"></input>
              </div>
              <div class="form-group mt-2">
                <label>Artiste</label>
                <input id="song-title" class="form-control"></input>
              </div>
              <div id="song-cdg" style="display:none;">
                <div class="form-group mt-2">
                  <label>Audio</label>
                  <input id="song-cdg-audio" class="form-control" readonly></input>
                  <!--audio controls muted id="song-cdg-audio" class="w-100"></audio-->
                </div>
                <div class="form-group mt-2">
                  <label>Paroles</label>
                  <input id="song-cdg-lyrics" class="form-control" readonly></input>
                  <!--canvas id="song-cdg-lyrics" class="w-100"></canvas-->
                </div>
              </div>
              <div class="form-group mt-2" id="song-karafun" style="display:none;">
                <label>Vidéo</label>
                <video muted id="song-karafun-video" class="w-100"></video>
                <div id="song-karafun-colors"></div>
              </div>
              <div class="form-group mt-2" id="song-singking" style="display:none;">
                <label>Vidéo</label>
                <video muted id="song-singking-video" class="w-100"></video>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            <button type="button" class="btn btn-primary">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Barre d'outils -->
    <nav class="navbar navbar-expand-md navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Karaoké</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" id="button:chroma"><i class="bi-eyedropper"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="button:stop"><i class="bi-stop-fill"></i></a>
            </li>
          </ul>
          <form class="d-flex">
            <input class="form-control me-2" type="search" placeholder="Rechercher" aria-label="Rechercher">
            <button class="btn btn-outline-success" type="submit"><i class="bi-search"></i></button>
          </form>
        </div>
      </div>
    </nav>
    <!-- Liste des chansons -->
    <ul id="songs" class="list-group list-group-flush w-75 mx-auto"></ul>
    <script type="module">
      import * as media  from "./js/media.js";
      import Webcam      from "./js/webcam.js";
      import VideoChroma from "./js/video-chroma.js";

      function str (s)
      {
        return s.normalize ('NFD').replace (/\p{Diacritic}/gu, '').toLowerCase ();
      }
      console.log (str ('Beyoncé'));

      // Fenêtre secondaire.
      let karaoke = window.open ('karaoke.html', 'Karaoke');
      if (karaoke != null)
      {
        // Webcam
        let constraints = {audio: false, video: {width: {min: 1280, ideal: 1920}, height: {min: 720, ideal: 1080}}};
        let webcam = new Webcam (constraints);
        webcam.ready.then (() => {
          webcam.video.play ();
          webcam.video.style.width = "50%";
          //webcam.video.style.height = "50%";
          let chroma = new VideoChroma (webcam.video);
          chroma.canvas.style.width = "50%";
          //chroma.canvas.style.height = "50%";
          webcam.video.onclick = media.ONCLICK (webcam.video, (r, g, b) => {
            console.log (r, g, b);
            chroma.chroma_key = [r, g, b];
            karaoke.postMessage ({type: 'chroma-key', value: [r, g, b]});
          });
          let modal = document.getElementById ('modal:chroma');
          let body = modal.querySelector ('.modal-body');
          body.append (webcam.video, chroma.canvas);
          let m = new bootstrap.Modal (modal);
          let button = document.getElementById ('button:chroma');
          button.onclick = () => {m.show ();};
        });

        // Propriétés d'une chanson.
        let song_modal = document.getElementById ('modal:song');
        let song_modal_body = song_modal.querySelector ('.modal-body');

        function song_item_onclick_cdg (song)
        {
          //console.log ('song_item_onclick_cdg');
          song_modal_body.querySelector ('#song-title').value = song.title;
          song_modal_body.querySelector ('#song-artist').value = song.artist;
          let cdg = song_modal_body.querySelector ('#song-cdg');
          cdg.style.display = 'block';
          song_modal_body.querySelector ('#song-cdg-audio').value = song.audio;
          song_modal_body.querySelector ('#song-cdg-lyrics').value = song.lyrics;
          song_modal.addEventListener ('hidden.bs.modal', e => {
            //console.log ('mp3+cdg', 'hidden.bs.modal');
            cdg.style.display = 'none';
          });
          let modal = new bootstrap.Modal (song_modal);
          modal.show ();
        }

        function song_item_onclick_karafun (song)
        {
          //console.log ('song_item_onclick_karafun');
          song_modal_body.querySelector ('#song-title').value = song.title;
          song_modal_body.querySelector ('#song-artist').value = song.artist;
          let karafun = song_modal_body.querySelector ('#song-karafun');
          karafun.style.display = 'block';
          let video = song_modal_body.querySelector ('#song-karafun-video');
          media.LOAD (video, 'songs/'+song.video).
            then (() => {
              video.play ();
            });
          song_modal.addEventListener ('hidden.bs.modal', e => {
            console.log ('karafun', 'hidden.bs.modal');
            karafun.style.display = 'none';
          });
          let modal = new bootstrap.Modal (song_modal);
          modal.show ();
        }

        function song_item_onclick (song)
        {
          console.log ('song_item_onclick', song.title);
          switch (song.type)
          {
            case 'mp3+cdg':
              return song_item_onclick_cdg (song);

            case 'karafun':
              return song_item_onclick_karafun (song);

            default:
              console.log (song.type);
              return null;
          }
        }

        function song_item (song)
        {
          let img = document.createElement ('img');
          img.className = 'm-1';
          img.width = 50;
          img.height = 50;
          img.src = song.icon;
          img.onclick = () => karaoke.postMessage ({type: 'play', song});

          let title = document.createElement ('div');
          title.innerHTML = song.title;
          let artist = document.createElement ('div');
          artist.className = 'text-secondary';
          artist.innerHTML = song.artist;
          let text = document.createElement ('div');
          text.className = 'd-flex flex-column flex-grow-1 m-2';
          text.append (title, artist);

          let settings = document.createElement ('button');
          settings.className = 'btn m-1';
          settings.innerHTML = '<i class="bi-three-dots"></i>';
          settings.onclick = () => song_item_onclick (song);

          let li = document.createElement ('li');
          li.className = 'list-group-item d-flex flex-row align-items-center';
          li.append (img, text, settings);
          return li;
        }

        function song_list (data)
        {
          let songs = document.getElementById ('songs');
          data.forEach (song => {
            console.log (song.title);
            songs.append (song_item (song));
          });
        }

        fetch ('songs.json').
          then (r => r.json ()).
          then (json => {
            song_list (json);
          });

        let stop = document.getElementById ('button:stop');
        stop.onclick = () => karaoke.postMessage ({type: 'stop'});
      }
    </script>
  </body>
</html>
