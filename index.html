<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>Karaoké</title>
    <style>
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0; padding: 0;

        height: 100%;
      }
      body {
        height: 100%;
        margin: 0; padding: 0;
      }
      #webcam {
        position: fixed;
        top: 10px;
        right: 10px;
        width: 200px;
        height: 150px;
      }
    </style>
  </head>

  <body>
    <button id="stop">STOP</button>
    <script type="module">
      import Webcam from "./webcam.js";

      function str (s)
      {
        return s.normalize ('NFD').replace (/\p{Diacritic}/gu, '').toLowerCase ();
      }

      console.log (str ('Beyoncé'));

      let options = null
      //let options = 'width=640,height=480,location=no,resizable=yes';
      let karaoke = window.open ('karaoke.html', 'Karaoke', options);
      if (karaoke != null)
      {
        let constraints = {audio: false, video: {width: {min: 1280, ideal: 1920}, height: {min: 720, ideal: 1080}}};
        let webcam = new Webcam (constraints);
        webcam.video.id = 'webcam';

        webcam.video.onclick = e => {
          console.log (e);

          let canvas = document.createElement ('canvas');
          let w = canvas.width  = webcam.video.clientWidth;
          let h = canvas.height = webcam.video.clientHeight;
          //document.body.appendChild (canvas);
          //console.log (w, h);

          let context = canvas.getContext ('2d');
          context.drawImage (webcam.video, 0, 0, w, h);
          let [r, g, b] = context.getImageData (e.offsetX, e.offsetY, 1, 1).data;
          console.log (r, g, b);
          karaoke.postMessage ({type: 'chroma-webcam', value: [r, g, b]});
        };

        document.body.appendChild (webcam.video);

        fetch ('songs.json').
          then (r => r.json ()).
          then (json => {
            json.forEach (song => {
              console.log (song.title);
              let button = document.createElement ('button');
              //button.innerHTML = song.artist + ' - ' + song.title;
              let img = document.createElement ('img');
              img.width = 200;
              img.height = 200;
              img.src = song.icon;
              button.appendChild (img);
              button.onclick = () => karaoke.postMessage ({type: 'play', song});
              document.body.appendChild (button);
            });
          });

        let stop = document.getElementById ('stop');
        stop.onclick = () => karaoke.postMessage ({type: 'stop'});
      }
    </script>
  </body>
</html>
